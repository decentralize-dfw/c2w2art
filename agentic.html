



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENCTIC GAME, Click is the new Biology.</title>
    <style>
        @font-face {
            font-family: 'PixelSix';
            src: url('https://github.com/decentralize-dfw/font/raw/main/pixelsix10.ttf') format('truetype');
        }
       
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%;
            height: 100%;
            font-family: 'PixelSix', monospace; /* FONT TEKLİĞİ İÇİN KULLANILDI */
            background: #000;
            color: #ccc;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            /* DÜZELTME: Tam ekran desteği için overflow hidden kalmalı */
            overflow: hidden;
        }
       
        #gameWrapper {
            /* DÜZELTME: Tam ekranı kaplamak için 100% vh/vw yerine 100% kullanıldı */
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            background-size: cover;
            background-position: center;
        }
       
        #gameContainer {
            width: 500px; /* Fixed container size (For scaling calculation) */
            height: 500px;
            display: flex;
            flex-direction: column;
            border: 8px solid #555;
            background: #2a2a2a;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
            position: relative;
            /* SCALING: JavaScript tarafından ayarlanır */
            transform: scale(var(--scale, 1));
            transform-origin: center;
            overflow: hidden;
        }
       
        #bootScreen, #transitionScreen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #2a2a2a;
            z-index: 500;
        }
        #transitionScreen {
            z-index: 600; /* On top */
            background: #000;
        }
       
        #bootScreen.active, #transitionScreen.active {
            display: flex;
        }
       
        #bootScreen img, #transitionScreen img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }
       
        #worldContainer {
            width: 100%;
            height: 100%;
            position: relative;
            display: none;
        }
       
        #worldContainer.active {
            display: block;
        }
       
        #mapCanvas {
            width: 100%;
            height: calc(100% - 30px);
            background: #2a2a2a;
            display: block;
            image-rendering: pixelated;
        }
       
        #mapFooter {
            width: 100%;
            height: 30px;
            background: #1a1a1a;
            border-top: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            font-family: 'PixelSix', monospace;
        }
       
        #battleContainer {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            background: #3a3a3a;
        }
       
        #battleContainer.active {
            display: flex;
        }
       
        .trainerInfo {
          display: none !important; /* Artık trainerInfo'yu kullanmıyoruz/göstermiyoruz */
            position: absolute;
            top: 5px;
            left: 5px;
            background: #3a3a3a;
            border: 2px solid #555;
            padding: 5px 8px;
            color: #ccc;
            font-size: 11px;
            z-index: 50;
        }
       
        #battleField {
            flex: 1;
            display: flex;
            justify-content: initial;
            align-items: initial;
            padding: 0;      
            background-size: cover;
            background-position: center;
            border-bottom: 2px solid #555;
            gap: 10px; /* Space between */
            position: relative; /* Shake için gerekli */

                 
        }
       
        /* EKRAN TİTREMESİ - Tüm battleField'i salla */
        #battleField.faintScreenShake {
            animation: screenShake 0.5s ease-in-out 3; /* 3 kez tekrarla */
        }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(-5px); }
            50% { transform: translateX(8px) translateY(5px); }
            75% { transform: translateX(-5px) translateY(8px); }
        }
        .pokemonSide {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            padding: 10px 0;
            min-width: 150px; /* Ekstra güvenlik için min-width */
        }
       
        /* PLAYER (LEFT) */
       .pokemonSide {
    /* Genel ayarlamaları kaldırın */
    display: initial;
    flex-direction: initial;
    gap: initial;
    flex: initial;
    padding: initial;
    min-width: initial;
}

.pokemonSide.player { 
  position: absolute;
  bottom: 15px;
  left: 15px;
   }



.pokemonSide.enemy {
    position: absolute;
    top: 5px;
    right: 5px;
}
.pokemonSide.player .pokemonDisplay {
    display: flex;
    flex-direction: column; /* Sprite ve HP kutusu alt alta olsun */
}
.pokemonSide.enemy .pokemonDisplay {
    display: flex;
    flex-direction: column-reverse; /* Sprite üstte, HP kutusu altta olsun (Klasik düzen) */
}
       
        .trainerSprite {
            width: 100px;
            height: 100px;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }
       
        .trainerSprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }
       
        .pokemonSprite { 
          width: 160px;
          height: 160px;
          border: 0px solid #555; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          background: transparent;
          /* Sadece görünür kalsın */ 
          transition: all 0.3s; }
       
        .pokemonSprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }
       
        .pokemonStats {
    background: #555;
    color: #ccc;
    padding: 6px 10px;
    border: 1px solid #777;
    font-size: 11px;
    text-align: center;
    min-width: 120px; /* Boyutunu büyüt */
    
    /* YENİ MUTLAK KONUMLANDIRMA */
    position: absolute; 
    z-index: 50;
    
    /* Diğer stilleri buraya ekleyeceğiz (aşağıya bakınız) */
}



/* OYUNCU BİLGİ KUTUSU (Sağ Alt) */
.pokemonSide.player .pokemonStats {
    bottom: 5px;
    right: 5px;
}

       
        .hpBar {
    width: 120px;
    height: 10px; /* Biraz kalınlaştırma */
    background: #000;
    border: 1px solid #888;
    margin: 3px 0;
}
       
        .hpFill {
            height: 100%;
            background: #00ff00;
            transition: width 0.3s;
        }
       
        #battleUI {
            background: #2a2a2a;
            border-top: 2px solid #555;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 0.7;
            position: relative;
            overflow: hidden; /* DÜZELTME: Battle UI'ın kendisi taşmasın */
        }
       
        .battleMessage {
            background: #3a3a3a;
            border: 1px solid #555;
            padding: 8px;
            color: #ccc;
            font-size: 11px;
            min-height: 24px;
            display: flex;
            align-items: center;
            position: relative;
        }
       
        .moveGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
       
        .battleBtn {
            padding: 6px;
            background: #555;
            color: #ccc;
            border: 1px solid #777;
            cursor: pointer;
            font-size: 10px;
            font-family: 'PixelSix', monospace;
            font-weight: bold;
            outline: none;
        }
       
        /* KLAVYE ODAK NOKTASI İÇİN YENİ STİL */
        .battleBtn.selected:not(:disabled),
        .switchBtn.selected:not(:disabled) {
            background: #007bff;
            border-color: #0056b3;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.8);
        }
       
        .battleBtn:hover:not(:disabled) { background: #666; }
        .battleBtn:disabled { opacity: 0.4; cursor: not-allowed; }
       
        .itemSection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        /* --- SWITCH MENU --- */
        #switchScreen {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Cover battleUI */
            background: #2a2a2a;
            z-index: 100;
            display: none;
            flex-direction: column;
            padding: 10px;
            gap: 8px;
            overflow-y: hidden;
        }
        #switchScreen.active {
            display: flex;
        }
        .switchGrid {
    display: grid;
    /* BU SATIRI DEĞİŞTİRİN */
    grid-template-columns: 1fr 1fr 1fr 1fr; 
    gap: 5px;
    flex: 1;
}
        .switchBtn {
            background: #444;
            color: #ccc;
            border: 1px solid #666;
            padding: 10px 5px;
            font-size: 10px;
            font-family: 'PixelSix', monospace;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
             outline: none;
        }
        .switchBtn:hover:not(:disabled) {
            background: #555;
        }
        .switchBtn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #333;
            color: #777;
        }
        .switchBtn img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            image-rendering: pixelated;
        }
        /* --- --- */
       
        .shake {
            animation: shake 0.15s;
        }
       
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        /* IMMERSIVE FAINT ANIMATION - YENİ VERSİYON */
        .pokemonSprite.fainted {
            border-color: #ff0000 !important; /* Kırmızı border */
        }
        .fainted {
            animation: immersiveFaint 4s forwards !important; /* Zorla uygula, 4s süre */
            position: relative; /* Pseudo-elements için */
        }
        @keyframes immersiveFaint {
            /* 0-1s: Şiddetli shake + kırmızı flash */
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) rotate(0deg);
                filter: hue-rotate(0deg) brightness(1);
                background: rgba(255, 0, 0, 0.3) !important; /* Kırmızı glow */
            }
            10%, 30%, 50%, 70% {
                transform: translateX(15px) translateY(-10px) scale(1.1) rotate(5deg);
                filter: hue-rotate(0deg) brightness(1.5); /* Parlaklık artışı */
                background: rgba(255, 50, 0, 0.6) !important;
            }
            20%, 40%, 60%, 80% {
                transform: translateX(-15px) translateY(10px) scale(0.9) rotate(-5deg);
                filter: hue-rotate(20deg) brightness(0.5); /* Kızıl ton + kararma */
                background: rgba(255, 0, 0, 0.8) !important;
            }
               
            /* 1-3s: Hızlı flash + küçülme */
            85% {
                opacity: 0.2;
                transform: scale(0.7) rotate(360deg);
                filter: grayscale(100%) brightness(0.3);
            }
            90% { opacity: 1; transform: scale(0.8) rotate(0deg); }
            95% { opacity: 0.1; transform: scale(0.5) rotate(180deg); }
               
            /* 3-4s: Son fade out + aşağı kayma */
            100% {
                opacity: 0;
                transform: scale(0.3) translateY(50px) rotate(720deg); /* Tam dönüş + kaybol */
                filter: grayscale(100%) brightness(0);
                background: transparent !important;
            }
        }
       
        /* --- VICTORY SCREEN --- */
       #victoryScreen {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 999;
    align-items: center;
    justify-content: center;
}

#victoryScreen.active {
    display: flex;
}

#victoryImageContainer {
    width: 100%;
    height: 100%;
}

#victoryImageContainer img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Tüm ekranı kaplar */
    image-rendering: pixelated;

        }
       
        #gameOverImg {
            display: none;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 300;
            background: #000;
        }
       
        #gameOverImg.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
       
        #gameOverImg img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* YENİ HARİTA DİYALOG KUTUSU */
        #mapDialogueOverlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: #2a2a2a;
            border-top: 4px solid #555;
            z-index: 100;
            display: none;
            padding: 10px;
            font-size: 11px;
            color: #ccc;
            align-items: center;
            justify-content: flex-start;
        }
        #mapDialogueOverlay.active {
            display: flex;
        }
        /* YENİ FLASH EFEKTİ */
        #flashOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0;
            z-index: 900;
            pointer-events: none;
        }
        @keyframes flash {
            0% { opacity: 0; }
            5% { opacity: 1; }
            10% { opacity: 0; }
            15% { opacity: 1; }
            20% { opacity: 0; }
            25% { opacity: 1; }
            30% { opacity: 0; }
            35% { opacity: 1; }
            40% { opacity: 0; }
            45% { opacity: 1; }
            50% { opacity: 0; }
            55% { opacity: 1; }
            60% { opacity: 0; }
            65% { opacity: 1; }
            70% { opacity: 0; }
            75% { opacity: 1; }
            80% { opacity: 0; }
            85% { opacity: 1; }
            90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        .flash-active {
            animation: flash 2s forwards;
        }
       
        /* ENTER PROMPT INDICATOR */
        .promptIndicator {
            position: absolute;
            right: 5px;
            bottom: 2px;
            font-size: 10px;
            color: #ffb703;
            animation: blink 0.5s step-start infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        /* DIALOG CHARACTER SPRITE */
        #dialogueCharacterSprite {
            width: 60px;
            height: 60px;
            margin-right: 10px;
            border: 2px solid #555;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #dialogueCharacterSprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }
    </style>
</head>
<body>
<div id="gameWrapper">
    <div id="gameContainer">
       
        <div id="bootScreen" class="active">
            <img src="" alt="Boot Screen" id="bootImg" style="width:100%; height:100%;">
        </div>
       
        <div id="transitionScreen">
            <!-- SADECE GEÇİŞ GIF'i -->
            <img src="" alt="Battle Transition" id="transitionImg" style="width:100%; height:100%;">
        </div>
       
        <div id="worldContainer">
            <canvas id="mapCanvas" width="500" height="470"></canvas>
            <div id="mapFooter">WASD directions, ENTER to select. Vibecoded Proudly. 2025</div>
           
            <!-- HARİTA ÜSTÜ DİYALOG KUTUSU -->
            <div id="mapDialogueOverlay">
                <div id="dialogueCharacterSprite"></div>
                <div id="mapDialogueText"></div>
                <span class="promptIndicator" id="mapPromptIndicator" style="display:none;">ENTER</span>
            </div>
           
            <!-- FLASH OVERLAY -->
            <div id="flashOverlay"></div>
        </div>
       
        <div id="battleContainer">
            
           <div id="battleField">
    <div class="pokemonStats" id="enemyStatsBox" style="position: absolute; top: 5px; left: 105px; text-align: left; min-width: 150px;">
        <div id="enemyName" style="font-weight: bold; margin-bottom: 3px; color: #fff;">Enemy</div>
        <div class="hpBar" style="width: 150px; height: 12px; margin-left: 20px;">
            <div class="hpFill" id="enemyHpBar" style="width: 100%;"></div>
        </div>
        <div style="font-size: 10px; position: absolute; top: 25px; left: 5px; color: #fff; background: #555; padding: 1px 3px;">
            <span id="enemyHp">100</span>/<span id="enemyMaxHp">100</span>
        </div>
    </div>
    
    <div class="pokemonStats" id="playerStatsBox" style="position: absolute; bottom: 5px; right: 105px; text-align: right; min-width: 150px;">
        <div id="playerName" style="font-weight: bold; margin-bottom: 3px; color: #fff;">Pokémon</div>
        <div class="hpBar" style="width: 150px; height: 12px; margin-right: 20px;">
            <div class="hpFill" id="playerHpBar" style="width: 100%;"></div>
        </div>
        <div style="font-size: 10px; position: absolute; top: 25px; right: 5px; color: #fff; background: #555; padding: 1px 3px;">
            <span id="playerHp">100</span>/<span id="playerMaxHp">100</span>
        </div>
    </div>

    <div class="pokemonSide enemy">
        <div class="pokemonSprite" id="enemySprite"></div>
    </div>
    
    <div class="pokemonSide player">
        <div class="pokemonSprite" id="playerSprite"></div>
    </div>

</div>
            
           
            <div id="battleUI">
                <!-- Main Battle Menu -->
                <div class="battleMessage" id="message">
                    Battle Start!
                    <span class="promptIndicator" id="battlePromptIndicator" style="display:none;">ENTER</span>
                </div>
                <div class="moveGrid" id="moveGrid"></div>
                <div class="itemSection" id="itemSection">
                    <button class="battleBtn" id="potionBtn">POTION (<span id="potionCount">10</span>)</button>
                    <button class="battleBtn" id="switchBtn">SWITCH</button>
                </div>
                <!-- Pokémon Switch Menu (Hidden) -->
                <div id="switchScreen">
                    <div class="battleMessage" id="switchMessage">Choose a Pokémon.</div>
                    <div class="switchGrid" id="switchGrid">
                        <!-- JS will populate this -->
                    </div>
                    <button class="battleBtn" id="cancelSwitchBtn" style="background: #a83232;">CANCEL</button>
                </div>
            </div>
        </div>
       
        <!-- VICTORY SCREEN SADELEŞTİRİLDİ -->
        <div id="victoryScreen">
            <div class="victoryImageContainer" id="victoryImageContainer">
                <!-- GIF/PNG BURADA GÖSTERİLECEK -->
            </div>
        </div>
       
        <div id="gameOverImg"></div>
    </div>
</div>
<script>
    // ===== SETUP SCALING =====
    // Ekran boyutunu hesapla ve oyunu ölçeklendir
    function setupScaling() {
        const gameContainer = document.getElementById('gameContainer');
        // Pencere boyutlarını al
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
       
        // 500x500 container boyutuna göre ölçek faktörünü hesapla
        const scaleX = vw / 500;
        const scaleY = vh / 500;
        // En küçük ölçeği seç (oyunun pencerede tam sığmasını sağlar)
        const scale = Math.min(scaleX, scaleY);
       
        // Ölçeği CSS değişkeni olarak uygula
        gameContainer.style.setProperty('--scale', scale);
    }
   
    // Pencere boyutu değiştiğinde ölçeklendirmeyi güncelle
    window.addEventListener('resize', setupScaling);
    // İlk yüklemede ölçeklendirmeyi ayarla
    setupScaling();
   
    // ===== GAME CONSTANTS & DATA (Aynı Kaldı) =====
   
    const MAP_GRID_SIZE = 60;
   
    // --- LINKS/ASSETS ---
    // --- LINKS/ASSETS ---
    const audio = {
        boot: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/intro-jinglee.mp3'),
        world: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/gamein.mp3'),
        // battle: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battle3.mp3'),
        victory: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/victory.mp3'), 
        victoryfinal: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/VICTORY-sound.mp3'), 
        battleIntro: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/BATTLE-INTRO31.mp3'),
        dialogueSound: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/ui_2.mp3'), 
        selectSound: new Audio(null), // OK HAREKETİ SESİ
        gameOver: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/GAMEOVER.mp3'),
        faint: new Audio('https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battle-start.mp3')
    };
    
// battle2.mp3
//   ui_2.mp3
   //  ui_1.mp3 balon gibi aq
   // select_1.mp3






    audio.boot.loop = false;
    audio.world.loop = true;
   // audio.battle.loop = true;
    audio.victory.loop = false;
    audio.victoryfinal.loop = false;
    audio.battleIntro.loop = false; 
    audio.dialogueSound.loop = false; 
    audio.selectSound.loop = false; 
    
//  agenticworld3.jpg
//  battlearena2BW.jpg
//  battlearena4.jpg

    const acilisResmiURL = 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/agentic-intro.gif';
    const arkaPlanResmiURL = 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/agentic.jpg';
    const haritaArkaPlanURL = 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/GAMEBACKGROUND5-C2.jpg';
    const savasArkaPlanURL = 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/agenticworld3.jpg'; 
    const savasGirisURL = 'https://media.giphy.com/media/l41lO5G7lEoyHw9oA/giphy.gif'; // DÜZELTME: GIF PLACEHOLDER
    
    const normalKupaURL = 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/youwon.gif'; // DÜZELTME: Normal Cup GIF
    const finalKupaURL = 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/VICTORY.gif'; // DÜZELTME: Final Cup GIF
    const kazandinURL = 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/VICTORY.gif';
    const kaybettinURL = 'KAYBETTİN_PNG';

    const playerCharacterSprites = {
        front: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/front.png', 
        back: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/back.png', 
        left: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/left.png', 
        right: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/right.png'
    };


    const trainerSprites = [
        'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/rival_1.png',
        'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/rival_2.png',
        'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/rival_3.png',
        'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/rival_4.png',
        'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/rival_5.png'
    ];
    document.getElementById('gameWrapper').style.backgroundImage = `url(${arkaPlanResmiURL})`;
    // document.getElementById('battleField').style.backgroundImage = `url(${savasArkaPlanURL})`;
    // POKÉMON TRAINERS


    





    const trainersData = [
       

      

    
       { // 1. Brock (Easy)
            name: 'Seize',
            sprite: trainerSprites[0],
            battleMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battle0.mp3', // YENİ MÜZİK LİNKİ 5
            battleBackground: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battleback-sect1jpg.jpg',
            newWorldMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/8bit.mp3', // Misty yenilince çalacak müzik
            preBattleDialogue: [
                {speaker: 'Seize', text: "Hey! Why dont you go vibe code another useless startup?"},
                {speaker: 'Player', text: "Hey Sir! Big fan. Didn't imagine you like this."},
                {speaker: 'Seize', text: "Seize the MEMES!"}
            ],
            postBattleDialogue: [
                {speaker: 'Seize', text: "I guess you memorized my threads well."},
                {speaker: 'Player', text: "Can I get a follow back?"},
                {speaker: 'Seize', text: "Lol"},
                {speaker: 'Player', text: "Can I?"},
                {speaker: 'Seize', text: "Ofcourse not."}
            ],
            pokemon: [
                { name: 'Weekend @ Saturn', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T1-1.png', maxHp: 95, hp: 95, moves: [{name: 'His fresh transhumanist agent swag', power: 25}, {name: 'S/O og punks', power: 30}, {name: 'Update Elise repo', power: 50}, {name: 'Smoke a pack of silver terea', power: 5}] },
                { name: 'Cant See Beep Bop Crap', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T1-2.png', maxHp: 120, hp: 120, moves: [{name: 'Posting naked famous everyday', power: 45}, {name: 'Shill nakamigos', power: 10}, {name: 'Buy 5000s for a bag', power: 20}, {name: 'Kick start a bull for a first time', power: 100}] },
                { name: 'Ferryman', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T1-3.png', maxHp: 150, hp: 150, moves: [{name: 'Glitch tf out of enemy', power: 28}, {name: 'Post unknown grail at Tumblr', power: 52}, {name: 'Make the enemy cc0', power: 15}, {name: 'bully some mid whale on dm', power: 58}] },
                { name: 'Bone on Air', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T1-4_1.png', maxHp: 170, hp: 170, moves: [{name: 'create a cult of 100 eth club', power: 58}, {name: 'mix primitive with digital', power: 22}, {name: 'make a spaceship out of bone', power: 25}, {name: 'hal900', power: 31}] }


                
            ]
        },

        { // 2. Misty
            name: 'Lydia',
            sprite: trainerSprites[1],
            battleMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battle4.mp3', // YENİ MÜZİK LİNKİ 5
            battleBackground: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battleback-sect2.jpg',
            newWorldMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/backg-part3.mp3',
            

            preBattleDialogue: [
                {speaker: 'Lydia', text: "Art derivative Agents are the best! Let's see you try to beat me!"},
                 {speaker: 'Player', text: "You mean AI gen copypasta shit?"},
                 {speaker: 'Lydia', text: "Naa. You have no idea what you are trashtalk about. Sportsmenship, but I'll reshape your Play-doh ass."},
                  {speaker: 'Player', text: "Try me!"}
            ],
            postBattleDialogue: [
                {speaker: 'Lydia', text: "Wow, maybe the market is not ready for artistic agents. I'll be waiting here."},
                {speaker: 'Player', text: "I'll be back Play-doh! Say hi to Henri..."},
                {speaker: 'Lydia', text: "He does not know that I'm here, fighting agents."},
                 {speaker: 'Player', text: "Enough. get lost bruh..."},
            ],
            pokemon: [
                { name: 'Devoured Remnant', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T2-1.png', maxHp: 180, hp: 180, moves: [{name: 'Paris Exhibition', power: 22}, {name: 'Flesh and Blood', power: 18}, {name: 'Hate & Love & Hate', power: 10}, {name: 'Crucufixion', power: 15}] },
                { name: 'Squallor', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T2-2.png', maxHp: 125, hp: 125, moves: [{name: 'Milano colonne birra becks', power: 20}, {name: 'Blow stripclub glow powder', power: 22}, {name: 'Dom p at nigthlub', power: 25}, {name: 'Become 3D from a painting', power: 8}] },
                { name: 'Wrestler of Silence', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T2-3.png', maxHp: 250, hp: 250, moves: [{name: 'Motion with Brush', power: 25}, {name: 'Miraculous Accident', power: 20}, {name: 'Post human wrestling', power: 22}, {name: 'Underground Bar Punch', power: 18}] }
            ]
        },
        

 { // 3. Lt. Surge
            name: 'Fashion Mofo with no sense but a good Copycat skills',
            sprite: trainerSprites[2],
            battleMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battle2.mp3', // YENİ MÜZİK LİNKİ 5
            battleBackground: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battleback-sect4.jpg',
            newWorldMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/whyweexist-score4.mp3',
            preBattleDialogue: [
                {speaker: 'Fashion Mofo with no sense but a good Copycat skills', text: "Oh you smell with those ugly trousers and cheap haircut. But, in good side, I hated your cologne. It made me feel something. And, you look lovely! Give me a hug..."}
            ],
            postBattleDialogue: [
                {speaker: 'Lt. Surge', text: "You earned this victory. You're fully charged!"}
            ],
            pokemon: [
                { name: 'Stow', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T3-1.png', maxHp: 145, hp: 145, moves: [{name: 'starts podcast', power: 60}, {name: 'render-free looks with wack low poly aesthetics', power: 30}, {name: 'roblox integration', power: 35}, {name: 'full black outfit', power: 15}] },
                { name: 'Joker', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T3-2.png', maxHp: 155, hp: 155, moves: [{name: 'AR Filter Mirrors are the future argument', power: 100}, {name: 'founder and creative director of my own brand update on linkedin', power: 22}, {name: 'Statement price explanation', power: 18}, {name: 'rick owens furniture', power: 25}] },
                { name: 'Zhoukouh', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T3-3.png', maxHp: 285, hp: 285, moves: [{name: 'explain why it is so hard to find a flat in Berlin', power: 2}, {name: 'Silent luxury + old money + sprezzatura + interoperability COMBOO', power: 150}, {name: 'Vintage Versace flip flops', power: 1}, {name: 'Shows her Instagram mutual friends', power: 2}] }
            ]
        },

       { // 4. Erika
            name: 'Steroive iObs',
            sprite: trainerSprites[3],
            battleMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battle3.mp3', // YENİ MÜZİK LİNKİ 5
            battleBackground: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/battleback-sect4_2.jpg',
            newWorldMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/backg-finalpart.mp3',
            preBattleDialogue: [
                {speaker: 'Steroive iObs', text: "Do you like memecoins? You can win a lot in a night."}
            ],
            postBattleDialogue: [
                {speaker: 'Steroive iObs', text: "What is the next giga thing? Mask off."}
            ],
            pokemon: [
                { name: 'Belli Capelli', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/t4_1.png', maxHp: 180, hp: 180, moves: [{name: 'Hack instagram', power: 26}, {name: 'social engineering', power: 38}, {name: 'bingewatch MR.robot', power: 12}, {name: 'Open a Romanese restaurant in Colonne', power: 62}] },
                { name: 'RR-Tiger', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T4-2.png', maxHp: 230, hp: 230, moves: [{name: 'Religious robotix', power: 68}, {name: 'Use of Chrome', power: 26}, {name: 'No gravity', power: 18}, {name: 'Use of contour', power: 16}] },
                { name: 'Asiah', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T4-3.png', maxHp: 270, hp: 270, moves: [{name: 'Launch V2 and distrube tokens to the land owners', power: 60}, {name: 'Make internet free', power: 48}, {name: 'Build Hyperfy', power: 50}, {name: 'Opensource the enemy', power: 14}] }
            ]
        },

        { // 5. Champion Blue (Hard)
            name: 'decentralize*',
            sprite: trainerSprites[4],
            battleMusic: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/finalbattle.mp3', // YENİ MÜZİK LİNKİ 5
            battleBackground: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/finale2.jpg',
            preBattleDialogue: [
                {speaker: 'decentralize*', text: "I created this game, so, I know how it works. Going to eat you like a kebab. Ayran too."},
                {speaker: 'decentralize*', text: "9 negronis, 3 pints of guinny, 2 packs of marl, some good tunes. Small talk. Then, your my meal. Just for fun."}
            ],
            postBattleDialogue: [
                {speaker: 'decentralize*', text: "Happy that you beat me. But I am still the champ."},
                {speaker: 'decentralize*', text: "Too old for this shit. See you at breakfast."},
                {speaker: 'decentralize*', text: "www.digitalforgerywork.shop"},
                {speaker: 'decentralize*', text: "Thank you for playing this game. Hope you enjoyed."},
                 {speaker: 'decentralize*', text: "Share this experience with friends."},
                  {speaker: 'decentralize*', text: "It is the moment, your agents are so good!"},
                  {speaker: 'decentralize*', text: "Time for a champain"},
                  {speaker: 'decentralize*', text: "Unless I give you those agents. aka pokemons."},
                   {speaker: 'decentralize*', text: "I loved the possibility that some outsider can beat me in my own game. Thats poetic. Thats passion. C2W2 BABYYYY"}
            ],
            pokemon: [
                 
                { name: 'NE_0hm', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T5-1.png', maxHp: 185, hp: 185, moves: [{name: 'explain the enemy that he is another NPC in a simulation that aliens use them as generator', power: 55}, {name: 'explain Trinity why Monica Belluci is better option', power: 32}, {name: 'Choose red pill and go to casino', power: 20}, {name: 'show leaked OF content of Agent Smith', power: 35}] },
                { name: 'Ya Bish Opps Mono', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T5-2.png', maxHp: 270, hp: 270, moves: [{name: 'Transhumanist Prayer', power: 45}, {name: 'Unite All AI against enemy', power: 62}, {name: 'Become opening avatar of C2W2 Runway section 5', power: 24}, {name: 'ask for a charity', power: 12}] },
                { name: 'XEU2', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/T5-3.png', maxHp: 330, hp: 330, moves: [{name: '01101011 01101001 01101100 01101100', power: 100}, {name: '01101110 01101111', power: 28}, {name: '01101001 01100100 01101011', power: 28}, {name: '01100110 01110101 01100011 01101011', power: 42}] },
                { name: 'C2W2 Gold', imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-thumb/main/logo_evo_14.png', maxHp: 405, hp: 405, moves: [{name: 'all avatars are vrm ready', power: 12}, {name: ' 1st time that metaverse experience can be watched straight from OpenSea', power: 8}, {name: '1st time that ultra-realistic, dynamic textile physics from Clo3D in browser metaverse', power: 10},{name: 'all avatars are vrm ready', power: 12}, {name: 'made this game just for fun', power: 15},{name: ' 1st time that metaverse experience can be watched straight from OpenSea', power: 8}, {name: 'enough. go watch the fucking runway.', power: 1000}] },
               
            ]
        },
    ];

   // face-1.png
   // face-2.png
   // face-3.png
   // face-4.png
   // mine-1.png
   // mine-2.png
   // mine-3.png
   // mine-4.png
   // mine-5.png
    // Player Pokémon
    const playerTeam = [
        { name: 'Curator', maxHp: 120, hp: 120, moves: [{name: 'Ask about recent sales', power: 50}, {name: 'curatorial text tsunami', power: 15}, {name: 'opening prosecco  tipsyness', power: 20}, {name: 'usage the word : Speculative', power: 65}], imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/zoom-1.png' },
        { name: 'Memelegance', maxHp: 100, hp: 100, moves: [{name: 'copypasta', power: 42}, {name: 'thats what she said', power: 12}, {name: 'big if true', power: 28}, {name: 'up only', power: 60}], imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/zoom-2.png' },
        { name: 'Founder Ape', maxHp: 130, hp: 130, moves: [ {name: 'Pump Fartcoin', power: 25}, {name: 'QT G4rg4', power: 20},{name: 'Build M$ NFT brand', power: 80}, {name: 'Buy Punks IP', power: 55}], imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/zoom-3.png' },
        { name: 'Chromozom', maxHp: 145, hp: 145, moves: [{name: 'Ignore DMs', power: 40}, {name: 'ArtTank Farm', power: 5}, {name: 'Buy Grail', power: 60}, {name: 'Throw GM', power: 25}], imageUrl: 'https://raw.githubusercontent.com/decentralize-dfw/c2w2-game/main/zoom-4.png' }
    ];
   
    // MAP PATH (Aynı Kaldı)
    const labyrinthPath = [
        {x: 10, y: 85}, {x: 11, y: 85}, {x: 12, y: 85}, {x: 13, y: 85}, {x: 14, y: 85}, {x: 15, y: 85},
        {x: 15, y: 84}, {x: 15, y: 83}, {x: 15, y: 82}, {x: 15, y: 81}, {x: 15, y: 80},
       
        {x: 16, y: 80}, {x: 17, y: 80}, {x: 18, y: 80}, {x: 19, y: 80}, {x: 20, y: 80},
        {x: 20, y: 79}, {x: 20, y: 78}, {x: 20, y: 77}, {x: 20, y: 76}, {x: 20, y: 75},
        {x: 19, y: 75}, {x: 18, y: 75}, {x: 17, y: 75}, {x: 16, y: 75}, {x: 15, y: 75}, {x: 14, y: 75}, {x: 13, y: 75},
        {x: 13, y: 74}, {x: 13, y: 73}, {x: 13, y: 72}, {x: 13, y: 71}, {x: 13, y: 70}, {x: 13, y: 69}, {x: 13, y: 68}, {x: 13, y: 67}, {x: 13, y: 66}, {x: 13, y: 65},
        {x: 14, y: 65}, {x: 15, y: 65}, {x: 16, y: 65}, {x: 17, y: 65}, {x: 18, y: 65}, {x: 19, y: 65}, {x: 20, y: 65}, {x: 21, y: 65}, {x: 22, y: 65}, {x: 23, y: 65}, {x: 24, y: 65}, {x: 25, y: 65},
        {x: 25, y: 64}, {x: 25, y: 63}, {x: 25, y: 62}, {x: 25, y: 61}, {x: 25, y: 60}, {x: 25, y: 59}, {x: 25, y: 58},
        {x: 26, y: 58}, {x: 27, y: 58}, {x: 28, y: 58}, {x: 29, y: 58}, {x: 30, y: 58},
        {x: 30, y: 57}, {x: 30, y: 56}, {x: 30, y: 55}, {x: 30, y: 54}, {x: 30, y: 53}, {x: 30, y: 52}, {x: 30, y: 51}, {x: 30, y: 50},
        {x: 31, y: 50}, {x: 32, y: 50}, {x: 33, y: 50}, {x: 34, y: 50},
        {x: 34, y: 49}, {x: 34, y: 48}, {x: 34, y: 47},
        {x: 33, y: 47}, {x: 32, y: 47}, {x: 31, y: 47}, {x: 30, y: 47},
        {x: 30, y: 46}, {x: 30, y: 45}, {x: 30, y: 44}, {x: 30, y: 43}, {x: 30, y: 42}, {x: 30, y: 41}, {x: 30, y: 40},
        {x: 31, y: 40}, {x: 32, y: 40}, {x: 33, y: 40}, {x: 34, y: 40},
        {x: 34, y: 39}, {x: 34, y: 38}, {x: 34, y: 37}, {x: 34, y: 36}, {x: 34, y: 35},
       
        {x: 33, y: 35}, {x: 32, y: 35}, {x: 31, y: 35}, {x: 30, y: 35}, {x: 29, y: 35}, {x: 28, y: 35},
        {x: 28, y: 34}, {x: 28, y: 33}, {x: 28, y: 32}, {x: 28, y: 31}, {x: 28, y: 30},
        {x: 27, y: 30}, {x: 26, y: 30}, {x: 25, y: 30}, {x: 24, y: 30}, {x: 23, y: 30},
        {x: 23, y: 29}, {x: 23, y: 28}, {x: 23, y: 27}, {x: 23, y: 26}, {x: 23, y: 25}, {x: 23, y: 24}, {x: 23, y: 23}, {x: 23, y: 22}, {x: 23, y: 21}, {x: 23, y: 20},
       
        {x: 23, y: 19}, {x: 23, y: 18}, {x: 23, y: 17}, {x: 23, y: 16}, {x: 23, y: 15}
    ];
   
    // TRAINER POSITIONS (Aynı Kaldı)
    const trainerPositions = [
        { x: 15, y: 80 },
        { x: 13, y: 65 },
        { x: 30, y: 50 },
        { x: 34, y: 35 },
        { x: 23, y: 20 }
    ];
    // Load image assets (Aynı Kaldı)
    const mapBgImage = new Image();
    mapBgImage.src = haritaArkaPlanURL;
   
    const playerImages = {};
    playerImages.front = new Image(); playerImages.front.src = playerCharacterSprites.front;
    playerImages.back = new Image(); playerImages.back.src = playerCharacterSprites.back;
    playerImages.left = new Image(); playerImages.left.src = playerCharacterSprites.left;
    playerImages.right = new Image(); playerImages.right.src = playerCharacterSprites.right;
    const trainerImages = trainerSprites.map(src => {
        const img = new Image();
        img.src = src;
        return img;
    });
   
    let gameState = {
        scene: 'boot',
        playerX: 10,
        playerY: 85,
        playerDirection: 'front',
        cameraX: 0,
        cameraY: 0,
        playerTeam: JSON.parse(JSON.stringify(playerTeam)),
        currentTeamIndex: 0,
        potions: 10,
        trainerIndex: 0,
        currentPokemonIndex: 0,
        currentBattle: null,
        isPlayerTurn: true,
        trainersDefeated: 0,
        dialogueSequence: [],
        dialogueCallback: null,
       
        battleMenuState: 'main', // 'main', 'move', 'switch'
        menuSelectionIndex: 0
    };
   
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
   
    // ===== DOM Elements (Aynı Kaldı) =====
    const switchScreen = document.getElementById('switchScreen');
    const switchGrid = document.getElementById('switchGrid');
    const cancelSwitchBtn = document.getElementById('cancelSwitchBtn');
    const moveGridEl = document.getElementById('moveGrid');
    const itemSectionEl = document.getElementById('itemSection');
    const switchBtnEl = document.getElementById('switchBtn');
    const mapDialogueOverlay = document.getElementById('mapDialogueOverlay');
    const mapDialogueText = document.getElementById('mapDialogueText');
    const battleMessageEl = document.getElementById('message');
    const dialogueCharacterSpriteEl = document.getElementById('dialogueCharacterSprite');
    const mapPromptIndicator = document.getElementById('mapPromptIndicator');
    const battlePromptIndicator = document.getElementById('battlePromptIndicator');
   
    // ===== UTILITY FUNCTIONS (Aynı Kaldı) =====
    function playDialogueSound() {
        try {
            if (audio.dialogueSound) {
                audio.dialogueSound.currentTime = 0;
                audio.dialogueSound.play().catch(e => console.log("Dialogue sound failed to play:", e));
            }
        } catch(e) {}
    }
   
    function playSelectSound() {
        try {
            if (audio.selectSound) {
                audio.selectSound.currentTime = 0;
                audio.selectSound.play().catch(e => console.log("Select sound failed to play:", e));
            }
        } catch(e) {}
    }
    function showPrompt(location) {
        if (location === 'map') {
            mapPromptIndicator.style.display = 'block';
        } else if (location === 'battle') {
            document.getElementById('battlePromptIndicator').style.display = 'block';
        }
    }
    function hidePrompt(location) {
        if (location === 'map') {
            mapPromptIndicator.style.display = 'none';
        } else if (location === 'battle') {
            const indicator = document.getElementById('battlePromptIndicator');
            if(indicator) indicator.style.display = 'none';
        }
    }
    // Harita üstü diyalog akışını başlatır
    function startMapDialogue(dialogueArray, callback) {
        gameState.scene = 'worldDialogue';
        gameState.dialogueSequence = dialogueArray.slice();
        gameState.dialogueCallback = callback;
        mapDialogueOverlay.classList.add('active');
        showNextDialogueLine();
    }
    // Diyalogda bir sonraki satırı gösterir
    function showNextDialogueLine() {
        hidePrompt('map');
        if (gameState.dialogueSequence.length > 0) {
            playDialogueSound();
            const line = gameState.dialogueSequence.shift();
           
            let spriteSrc = '';
            if (line.speaker === 'Player') {
                spriteSrc = playerCharacterSprites.front;
            } else {
                const currentTrainer = trainersData[gameState.trainersDefeated];
                if (currentTrainer) {
                    spriteSrc = currentTrainer.sprite;
                }
            }
            dialogueCharacterSpriteEl.innerHTML = spriteSrc ? `<img src="${spriteSrc}" alt="${line.speaker}">` : '<span>?</span>';
           
            mapDialogueText.innerHTML = `<strong>${line.speaker}:</strong> ${line.text}`;
           
            if (gameState.dialogueSequence.length === 0) {
                showPrompt('map');
            }
        } else {
            mapDialogueOverlay.classList.remove('active');
            hidePrompt('map');
           
            if (gameState.dialogueCallback) {
                const callbackToExecute = gameState.dialogueCallback;
                gameState.dialogueCallback = null;
                callbackToExecute();
            }
            if (gameState.scene === 'worldDialogue') {
                 gameState.scene = 'world';
            }
        }
    }
    // Savaş UI'ında diyalog akışını başlatır
    function showBattleMessageSequence(messages, callback) {
        gameState.scene = 'battleDialogue';
        gameState.dialogueSequence = messages.slice();
        gameState.dialogueCallback = callback;
       
        moveGridEl.style.display = 'none';
        itemSectionEl.style.display = 'none';
       
        showNextBattleLine();
    }
    // Savaş UI'ında bir sonraki diyalog satırını gösterir
    function showNextBattleLine() {
        // ENTER gösterimini sıfırla
        const messageText = battleMessageEl.textContent;
        battleMessageEl.innerHTML = messageText.replace(/<span.*?ENTER<\/span>/i, '').trim();
        hidePrompt('battle');
        if (gameState.dialogueSequence.length > 0) {
            playDialogueSound();
            const line = gameState.dialogueSequence.shift();
           
            if (gameState.currentBattle && gameState.currentBattle.name) {
                battleMessageEl.textContent = `[${line.speaker}] ${line.text}`;
            } else {
                battleMessageEl.textContent = line.text;
            }
           
            if (gameState.dialogueSequence.length === 0) {
                // Sadece son satırda ENTER göster
                battleMessageEl.innerHTML += ` <span class="promptIndicator" id="battlePromptIndicator">ENTER</span>`;
                showPrompt('battle');
            }
        } else {
            // Diyalog bitti
            moveGridEl.style.display = 'grid';
            itemSectionEl.style.display = 'grid';
            hidePrompt('battle');
           
            if (gameState.scene === 'battleDialogue') {
                 gameState.scene = 'battle';
            }
           
            if (gameState.dialogueCallback) {
                const callbackToExecute = gameState.dialogueCallback;
                gameState.dialogueCallback = null;
                callbackToExecute();
            }
            if (gameState.scene === 'battle') {
                updateBattle();
            }
        }
    }
    // Seçili butona vurgu ekler
    function updateMenuSelection() {
        let buttons = [];
       
        if (gameState.battleMenuState === 'main' || gameState.battleMenuState === 'move') {
            // Ana menü (4 buton) ve Move menüsü (4 saldırı butonu) aynı grid yapısını kullanır.
            // Move menüsündeyken sadece saldırı butonları aktif olmalıdır (alttaki itemSection görünmez)
            if (gameState.battleMenuState === 'main') {
                buttons = Array.from(document.querySelectorAll('#moveGrid .battleBtn, #itemSection .battleBtn'));
            } else { // 'move' state
                buttons = Array.from(document.querySelectorAll('#moveGrid .battleBtn'));
            }
           
        } else if (gameState.battleMenuState === 'switch') {
            // Pokémon switch butonları ve cancel butonu
            buttons = Array.from(document.querySelectorAll('#switchGrid .switchBtn:not(:disabled)'));
            if (document.getElementById('cancelSwitchBtn')) {
                buttons.push(document.getElementById('cancelSwitchBtn'));
            }
        }
       
        const availableButtons = buttons.filter(btn => !btn.disabled);
        if (availableButtons.length === 0) {
            gameState.menuSelectionIndex = 0;
            return;
        }
        gameState.menuSelectionIndex = Math.max(0, Math.min(gameState.menuSelectionIndex, availableButtons.length - 1));
        // Tüm vurguları kaldır
        document.querySelectorAll('.battleBtn, .switchBtn').forEach(btn => btn.classList.remove('selected'));
        // Seçili butona vurgu ekle
        if (availableButtons.length > 0) {
            availableButtons[gameState.menuSelectionIndex].classList.add('selected');
        }
    }
   
    // Klavye ile menü seçimi
    function handleBattleMenuInput(e) {
        const isForcedSwitchActive = gameState.battleMenuState === 'switch' && document.getElementById('cancelSwitchBtn').disabled;

        if (!gameState.isPlayerTurn && !isForcedSwitchActive) return;
        
        if (gameState.scene !== 'battle' && gameState.scene !== 'battleDialogue') return;
        let buttons = [];
        let numCols = 2;
       
        if (gameState.battleMenuState === 'main') {
            buttons = Array.from(document.querySelectorAll('#moveGrid .battleBtn, #itemSection .battleBtn'));
        } else if (gameState.battleMenuState === 'move') {
            buttons = Array.from(document.querySelectorAll('#moveGrid .battleBtn')); // Sadece saldırı butonları
        } else if (gameState.battleMenuState === 'switch') {
            numCols = 4;
            buttons = Array.from(document.querySelectorAll('#switchGrid .switchBtn:not(:disabled)'));
            if (document.getElementById('cancelSwitchBtn')) {
                buttons.push(document.getElementById('cancelSwitchBtn'));
            }
        }
        const availableButtons = buttons.filter(btn => !btn.disabled);
        const currentSelection = gameState.menuSelectionIndex;
        let newSelection = currentSelection;
        let changed = false;
        if (availableButtons.length === 0) return;
        // Yatay hareketler
        if (e.key === 'ArrowLeft') {
            if (currentSelection % numCols !== 0) {
                newSelection = currentSelection - 1;
                changed = true;
            } else if (currentSelection === availableButtons.length - 1 && gameState.battleMenuState === 'switch') {
                 // Switch menüsünde cancel'dan sol butona geçiş
                newSelection = currentSelection - 1;
                changed = true;
            }
        } else if (e.key === 'ArrowRight') {
            if (currentSelection % numCols < numCols - 1 && currentSelection + 1 < availableButtons.length) {
                newSelection = currentSelection + 1;
                changed = true;
            }
        }
        // Dikey hareketler
        else if (e.key === 'ArrowUp') {
            if (gameState.battleMenuState === 'switch' && currentSelection === availableButtons.length - 1) {
                // Switch menüsünde cancel'dan yukarı çıkma
                newSelection = currentSelection - (currentSelection % numCols) - numCols;
                newSelection = Math.max(0, newSelection);
                changed = true;
            } else {
                newSelection = Math.max(0, currentSelection - numCols);
                changed = newSelection !== currentSelection;
            }
        } else if (e.key === 'ArrowDown') {
            if (currentSelection + numCols < availableButtons.length) {
                newSelection = currentSelection + numCols;
                changed = newSelection !== currentSelection;
            } else if (gameState.battleMenuState === 'switch' && currentSelection < availableButtons.length - 1) {
                // Switch menüsünde son satırdan cancel'a inme
                newSelection = availableButtons.length - 1;
                changed = newSelection !== currentSelection;
            }
        }
        if (changed) {
            gameState.menuSelectionIndex = newSelection;
            playSelectSound();
            updateMenuSelection();
            e.preventDefault();
            return;
        }
       
        // Enter tuşu ile seçim yap
        if (e.key === 'Enter') {
            e.preventDefault();
            if (availableButtons.length > 0) {
                const selectedButton = availableButtons[currentSelection];
               
                if (gameState.battleMenuState === 'main' || gameState.battleMenuState === 'move') {
                    // Saldırı butonu mu?
                    const moveButtons = Array.from(moveGridEl.children);
                    const moveIndex = moveButtons.indexOf(selectedButton);
                   
                    if (moveIndex !== -1) {
                        // Saldırıyı yap
                        playerAttack(moveIndex);
                        gameState.battleMenuState = 'main'; // İşlem sonrası ana menüye geri dön
                    } else if (selectedButton.id === 'potionBtn') {
                        usePotion();
                        gameState.battleMenuState = 'main'; // İşlem sonrası ana menüye dön
                    } else if (selectedButton.id === 'switchBtn') {
                        // Switch menüsüne geçiş
                        gameState.battleMenuState = 'switch';
                        gameState.menuSelectionIndex = 0;
                        updateBattle();
                    }
                } else if (gameState.battleMenuState === 'switch') {
                    // Switch/Cancel seçimi yapıldı
                    if (selectedButton.id === 'cancelSwitchBtn') {
                        cancelSwitch();
                    } else {
                        const switchIndex = Array.from(switchGrid.children).indexOf(selectedButton);
                        // DÜZELTME: Switch'i direkt yap ve ana menüye dön
                        executeSwitch(switchIndex);
                        // executeSwitch içinde zaten menü 'main' e dönüyor.
                    }
                }
            }
        }
    }
    // ===== GAME FLOW FUNCTIONS (Hata düzeltmesi için yukarı taşındı) =====
   
    function showBootScreen() {
        document.getElementById('bootImg').src = acilisResmiURL;
        const bootScreen = document.getElementById('bootScreen');
        bootScreen.classList.add('active');
       
        try {
            audio.boot.play().catch(e => console.log("Waiting for interaction to play music."));
        } catch(e) {
            console.log("Could not play music.", e);
        }
       
        setTimeout(() => {
            bootScreen.classList.remove('active');
            showWorldMap();
        }, 13000);  // İNTRO intro 13000
    }
   
    function showWorldMap() {
        gameState.scene = 'world';
        document.getElementById('worldContainer').classList.add('active');
        document.getElementById('battleContainer').classList.remove('active');
        document.getElementById('victoryScreen').classList.remove('active');
       
        audio.boot.pause();
        audio.boot.currentTime = 0;
        audio.victory.pause();
        audio.victory.currentTime = 0;
        audio.victoryfinal.pause();
        audio.victoryfinal.currentTime = 0;
       
        try {
            audio.world.play().catch(e => console.log("Waiting for interaction to play world music."));
        } catch(e) {
            console.log("Could not play world music.", e);
        }
       
        if (gameState.trainersDefeated > 0) {
            const pos = trainerPositions[gameState.trainersDefeated - 1];
            gameState.playerX = pos.x;
            gameState.playerY = pos.y;
        }
        drawWorld();
    }
   
    // BATTLE START FLASH & MUSIC
    function startBattle(trainerIdx) {
    if (gameState.scene === 'battle' || gameState.scene === 'transition') return;
    gameState.scene = 'transition';
    
    // 1. DÜŞMAN ARKA PLANINI AYARLA
    const selectedTrainer = trainersData[trainerIdx];
    document.getElementById('battleField').style.backgroundImage = `url(${selectedTrainer.battleBackground})`;
    document.getElementById('battleField').style.backgroundSize = 'cover'; // Kaplama ayarını koru
    document.getElementById('battleField').style.backgroundPosition = 'center'; // Ortalamayı koru
    
    audio.world.pause();
    audio.world.currentTime = 0;
    
    const flashOverlay = document.getElementById('flashOverlay');
    flashOverlay.classList.add('flash-active');
    
    try {
        audio.battleIntro.play().catch(e => console.log("Could not play battle intro music."));
    } catch(e) {}
    
    // MÜZİK DÜZELTMESİ İÇİN YENİ BİR OBJE OLUŞTURULDU
    const currentBattleMusic = new Audio(trainersData[trainerIdx].battleMusic);
    currentBattleMusic.loop = true; // Savaş müziği sürekli çalmalı
    
    setTimeout(() => {
        flashOverlay.classList.remove('flash-active');
        
        try {
            // YENİ MÜZİK ÇAĞRISI
            currentBattleMusic.play().catch(e => console.log("Waiting for interaction to play custom battle music."));
            // Mevcut savaş objesine müziği ekle (trainerDefeated'da durdurmak için)
            gameState.currentBattleMusic = currentBattleMusic; 
        } catch(e) {}
        
        gameState.scene = 'battle';
        gameState.trainerIndex = trainerIdx;
        gameState.currentPokemonIndex = 0;
        gameState.isPlayerTurn = true;
        
        let firstHealthyPokemon = -1;
        for(let i=0; i < gameState.playerTeam.length; i++) {
            if(gameState.playerTeam[i].hp > 0) {
                firstHealthyPokemon = i;
                break;
            }
        }
        if(firstHealthyPokemon === -1) {
            endGame(false);
            return;
        }
        gameState.currentTeamIndex = firstHealthyPokemon;
        gameState.currentBattle = JSON.parse(JSON.stringify(trainersData[trainerIdx]));
        
        document.getElementById('worldContainer').classList.remove('active');
        document.getElementById('battleContainer').classList.add('active');
        // document.getElementById('trainerName').textContent = gameState.currentBattle.name;
        
        gameState.battleMenuState = 'main';
        
        updateBattle();
        // Battle start mesajını diyalog akışı olarak göster
        showBattleMessageSequence([{speaker: gameState.currentBattle.name, text: `I, ${gameState.currentBattle.name}, challenge you! `}]);
    }, 2000);
}
    // Update battle screen
    function updateBattle() {
        // DÜZELTME: Güvenlik kontrolü, hata mesajını azaltır.
        if (gameState.scene !== 'battle' || !gameState.currentBattle || gameState.currentPokemonIndex >= gameState.currentBattle.pokemon.length) {
            // Bu hata, sadece mantık sıralamasında bir sorun olduğunda veya oyun bitmeden çağrıldığında görülür.
            // UI'ı güncellemek mantıksız olduğu için buradan hemen çıkıyoruz.
            // console.error("Battle state is inconsistent. Cannot update UI.");
            return;
        }
        const playerPoke = gameState.playerTeam[gameState.currentTeamIndex];
        const enemyPoke = gameState.currentBattle.pokemon[gameState.currentPokemonIndex];
       
        document.getElementById('playerName').textContent = playerPoke.name;
        document.getElementById('playerHp').textContent = playerPoke.hp;
        document.getElementById('playerMaxHp').textContent = playerPoke.maxHp;
        document.getElementById('playerHpBar').style.width = (playerPoke.hp / playerPoke.maxHp) * 100 + '%';
        const playerSpriteEl = document.getElementById('playerSprite');
        playerSpriteEl.innerHTML = `<img src="${playerPoke.imageUrl}" alt="${playerPoke.name}">`;
        playerSpriteEl.classList.remove('fainted');
       
        document.getElementById('enemyName').textContent = enemyPoke.name;
        document.getElementById('enemyHp').textContent = enemyPoke.hp;
        document.getElementById('enemyMaxHp').textContent = enemyPoke.maxHp;
        document.getElementById('enemyHpBar').style.width = (enemyPoke.hp / enemyPoke.maxHp) * 100 + '%';
        const enemySpriteEl = document.getElementById('enemySprite');
        enemySpriteEl.innerHTML = `<img src="${enemyPoke.imageUrl}" alt="${enemyPoke.name}">`;
        enemySpriteEl.classList.remove('fainted');
       
        //document.getElementById('pokemonIndex').textContent = `${gameState.currentPokemonIndex + 1}/${gameState.currentBattle.pokemon.length}`;
       
        const moveGrid = moveGridEl;
        moveGrid.innerHTML = '';
       
        if (gameState.battleMenuState !== 'switch') {
            // Saldırı butonlarını oluştur
            playerPoke.moves.forEach((move) => {
                const btn = document.createElement('button');
                btn.className = 'battleBtn';
                btn.textContent = move.name;
                btn.disabled = !gameState.isPlayerTurn;
                moveGrid.appendChild(btn);
            });
            // Alt menü butonlarını göster/gizle
            moveGridEl.style.display = 'grid';
            itemSectionEl.style.display = 'grid';
           
            document.getElementById('potionBtn').disabled = gameState.potions === 0 || !gameState.isPlayerTurn || playerPoke.hp === playerPoke.maxHp;
           
            let canSwitch = false;
            for(let i=0; i < gameState.playerTeam.length; i++) {
                if(i !== gameState.currentTeamIndex && gameState.playerTeam[i].hp > 0) {
                    canSwitch = true;
                    break;
                }
            }
            switchBtnEl.disabled = !gameState.isPlayerTurn || !canSwitch;
            document.getElementById('potionCount').textContent = gameState.potions;
            // Switch menüsünü gizle
            switchScreen.classList.remove('active');
           
        } else if (gameState.battleMenuState === 'switch') {
             // Switch menüsü aktif
            moveGridEl.style.display = 'none';
            itemSectionEl.style.display = 'none';
           
            // Switch menüsünü göster ve seçimleri güncelle
            showSwitchPokemonMenu();
        }
        if (gameState.isPlayerTurn) {
             updateMenuSelection();
        }
    }
   
    // Player attack
    function playerAttack(moveIdx) {
        if (!gameState.isPlayerTurn) return;
       
        gameState.isPlayerTurn = false;
        disableButtons();
       
        const playerPoke = gameState.playerTeam[gameState.currentTeamIndex];
        const enemyPoke = gameState.currentBattle.pokemon[gameState.currentPokemonIndex];
        const move = playerPoke.moves[moveIdx];
       
        const damage = Math.floor(Math.random() * 10 + move.power * 1.5);
        enemyPoke.hp = Math.max(0, enemyPoke.hp - damage);
       
        document.getElementById('playerSprite').classList.add('shake'); // YENİ VE DOĞRU
setTimeout(() => document.getElementById('playerSprite').classList.remove('shake'), 150);
       
        showBattleMessageSequence([{speaker: playerPoke.name, text: `Used ${move.name}! ${damage} DMG!`}], () => {
            if (enemyPoke.hp <= 0) {
                defeatPokemon();
            } else {
                setTimeout(enemyAttack, 1000);
            }
        });
        updateBattleHealth();
    }
   
    // Enemy attack
    function enemyAttack() {
        const playerPoke = gameState.playerTeam[gameState.currentTeamIndex];
        const enemyPoke = gameState.currentBattle.pokemon[gameState.currentPokemonIndex];
        const move = enemyPoke.moves[Math.floor(Math.random() * enemyPoke.moves.length)];
       
        const damage = Math.floor(Math.random() * 10 + move.power * 1.5);
        playerPoke.hp = Math.max(0, playerPoke.hp - damage);
       
        document.getElementById('enemySprite').classList.add('shake'); // YENİ VE DOĞRU
setTimeout(() => document.getElementById('enemySprite').classList.remove('shake'), 150);
       
        showBattleMessageSequence([{speaker: enemyPoke.name, text: `Enemy ${enemyPoke.name} used ${move.name}! ${damage} DMG!`}], () => {
            if (playerPoke.hp <= 0) {
                defeatPlayerPokemon();
            } else {
                gameState.isPlayerTurn = true;
                gameState.battleMenuState = 'main'; // Ana menüye dön
                updateBattle();
            }
        });
        updateBattleHealth();
    }
   
    // Update only health bars
    function updateBattleHealth() {
        const playerPoke = gameState.playerTeam[gameState.currentTeamIndex];
        // DÜZELTME: Sadece currentBattle kontrolü yeterli değil, index kontrolü de eklenmeli
        if (!gameState.currentBattle || gameState.currentPokemonIndex >= gameState.currentBattle.pokemon.length) return;
        const enemyPoke = gameState.currentBattle.pokemon[gameState.currentPokemonIndex];
        document.getElementById('playerHp').textContent = playerPoke.hp;
        document.getElementById('playerHpBar').style.width = (playerPoke.hp / playerPoke.maxHp) * 100 + '%';
       
        document.getElementById('enemyHp').textContent = enemyPoke.hp;
        document.getElementById('enemyHpBar').style.width = (enemyPoke.hp / enemyPoke.maxHp) * 100 + '%';
    }
    // Temporarily disable buttons
    function disableButtons() {
        document.querySelectorAll('.battleBtn, .switchBtn').forEach(btn => btn.disabled = true);
    }
    // Enemy pokemon fainted
    function defeatPokemon() {
        // Hata kontrolü tekrar
        if (!gameState.currentBattle || gameState.currentPokemonIndex >= gameState.currentBattle.pokemon.length) return;
        battleMessageEl.textContent = `Enemy ${gameState.currentBattle.pokemon[gameState.currentPokemonIndex].name} Fainted!`;

        try {
        audio.faint.currentTime = 0;
        audio.faint.play().catch(e => {});
    } catch(e) {}
       
        const enemySprite = document.getElementById('enemySprite');
        enemySprite.classList.add('fainted'); // Ana animasyon
        // EKRAN TİTREMESİ EKLE (immersive!)
        const battleField = document.getElementById('battleField');
        battleField.classList.add('faintScreenShake');
        setTimeout(() => {
            battleField.classList.remove('faintScreenShake'); // Temizle
            gameState.currentPokemonIndex++;
            if (gameState.currentPokemonIndex >= gameState.currentBattle.pokemon.length) {
                showBattleMessageSequence(trainersData[gameState.trainerIndex].postBattleDialogue, trainerDefeated);
            } else {
                showBattleMessageSequence([{speaker: gameState.currentBattle.name, text: `${gameState.currentBattle.name} sent out ${gameState.currentBattle.pokemon[gameState.currentPokemonIndex].name}!`}], () => {
                    gameState.isPlayerTurn = true;
                    gameState.battleMenuState = 'main';
                    updateBattle();
                });
            }
        }, 4500); // Animasyon süresine göre ayarlandı (4s + biraz fazlalık)
    }
   
    // Player pokemon fainted
    function defeatPlayerPokemon() {
    battleMessageEl.textContent = `${gameState.playerTeam[gameState.currentTeamIndex].name} Fainted!`;
    
    try {
        audio.faint.currentTime = 0;
        audio.faint.play().catch(e => {});
    } catch(e) {}

    const playerSprite = document.getElementById('playerSprite');
    playerSprite.classList.add('fainted'); // Ana animasyon
    const battleField = document.getElementById('battleField');
    battleField.classList.add('faintScreenShake');
    
    let hasHealthyPokemon = gameState.playerTeam.some(p => p.hp > 0); 

    setTimeout(() => {
            battleField.classList.remove('faintScreenShake'); // Temizle
            
            if (hasHealthyPokemon) {
                // CRITICAL FIX: ZORUNLU GEÇİŞTE KLAVYE KONTROLÜ İÇİN TURN'Ü OYUNCUYA VER
                gameState.isPlayerTurn = true; // <--- HATA DÜZELTME
                
                gameState.isForcedSwitch = true; 
                gameState.battleMenuState = 'switch';
                updateBattle(); 
                showBattleMessageSequence([{speaker: 'Player', text: `You must choose a new Pokémon!`}]); 
            } else {
                endGame(false);
            }
        }, 4500);
}
   
    // Trainer defeated
    // Trainer defeated
// Trainer defeated
function trainerDefeated() {
    // Özel savaş müziğini durdur
    if (gameState.currentBattleMusic) {
        gameState.currentBattleMusic.pause();
        gameState.currentBattleMusic.currentTime = 0;
    }
    
    gameState.trainersDefeated++;
    
    for (let poke of gameState.playerTeam) {
        poke.hp = poke.maxHp;
    }
    const victoryScreen = document.getElementById('victoryScreen');
    
    // Yenen antrenörün verilerini al
    const defeatedTrainerIndex = gameState.trainersDefeated - 1;
    const defeatedTrainerData = trainersData[defeatedTrainerIndex];

    if (gameState.trainersDefeated >= trainersData.length) {
        // --- SON BOSS ZAFERİ ---
        try {
            audio.victoryfinal.play().catch(e => {});
        } catch(e) {}
        
        document.getElementById('battleContainer').classList.remove('active');
        victoryScreen.classList.add('active');
        
        document.getElementById('victoryImageContainer').innerHTML = `<img src="${finalKupaURL}" alt="Champion Cup">`;
        
        setTimeout(() => {
            // Finalden sonra dünya haritasına dönüş yok
        }, 5000);
    } else {
        // --- NORMAL ANTRENÖR ZAFERİ ---
        
        // SADECE TEK TİP GENEL ZAFER MÜZİĞİNİ ÇAL
        try {
            audio.victory.currentTime = 0;
            audio.victory.play().catch(e => {});
        } catch(e) {}
        
        document.getElementById('battleContainer').classList.remove('active');
        victoryScreen.classList.add('active');
        
        document.getElementById('victoryImageContainer').innerHTML = `<img src="${normalKupaURL}" alt="Victory Cup">`;
        
        // 5 saniye sonra haritaya dön ve YENİ DÜNYA MÜZİĞİNİ AYARLA
        setTimeout(() => {
            
            if (defeatedTrainerData && defeatedTrainerData.newWorldMusic) {
                // Mevcut dünya müziğini durdur
                audio.world.pause();
                audio.world.currentTime = 0;
                
                // Yeni müziği yükle ve audio.world değişkenini kalıcı olarak güncelle
                audio.world = new Audio(defeatedTrainerData.newWorldMusic);
                audio.world.loop = true; // Dünya müziği döngü yapmalı
            }
            
            showWorldMap();
        }, 5000);
    }
}
   
    // Use Potion
    function usePotion() {
        if (gameState.potions > 0 && gameState.isPlayerTurn) {
            const playerPoke = gameState.playerTeam[gameState.currentTeamIndex];
            if(playerPoke.hp === playerPoke.maxHp) {
                showBattleMessageSequence([{speaker: playerPoke.name, text: `HP is full, cannot use Potion!`}]);
                gameState.isPlayerTurn = true;
                gameState.battleMenuState = 'main';
                updateBattle();
                return;
            }
            gameState.potions--;
            playerPoke.hp = playerPoke.maxHp;
           
            showBattleMessageSequence([{speaker: 'Player', text: `Used Potion! ${playerPoke.name} healed completely!`}], () => {
                setTimeout(enemyAttack, 1000);
            });
            document.getElementById('potionCount').textContent = gameState.potions;
           
            gameState.isPlayerTurn = false;
            disableButtons();
            updateBattleHealth();
        }
    }
   
    // Show switch menu
    // YENİ FONKSİYON
function showSwitchPokemonMenu() {
    // isForcedSwitch değişkeni, eğer oyuncu Pokémon'u bayıldıysa (defeatPlayerPokemon'da) 'true' olur.
    // Varsayılan olarak (switch butonuna basıldığında) 'false' kabul edilir.
    const isForced = gameState.isForcedSwitch || false; 

    // isForcedSwitch'i temizle, böylece bir sonraki çağrı normal olur
    gameState.isForcedSwitch = false; 

    if (!gameState.isPlayerTurn && !isForced) return;

    gameState.battleMenuState = 'switch';
    if (!isForced) { // Zorunlu değilse index'i sıfırla
        gameState.menuSelectionIndex = 0;
    }
    
    moveGridEl.style.display = 'none';
    itemSectionEl.style.display = 'none';
    switchScreen.classList.add('active');
    switchGrid.innerHTML = '';
    
    // CANCEL BUTONUNU ZORUNLU GEÇİŞ DURUMUNA GÖRE AYARLA
    const cancelBtn = document.getElementById('cancelSwitchBtn');
    if (cancelBtn) {
        // Eğer Zorunlu Geçiş İSE (Pokémon bayıldıysa), CANCEL KAPALI olmalı.
        cancelBtn.disabled = isForced; 
        if (isForced) {
            cancelBtn.style.opacity = '0.4'; // Soluk göstermek için
        } else {
            cancelBtn.style.opacity = '1'; // Normal göstermek için
        }
    }

    gameState.playerTeam.forEach((poke, index) => {
        // ... (Pokémon butonlarını oluşturma mantığı aynı kalacak)
        const btn = document.createElement('button');
        btn.className = 'switchBtn';
        btn.innerHTML = `
            <img src="${poke.imageUrl}" alt="${poke.name}">
            <div>${poke.name}</div>
            <div>${poke.hp} / ${poke.maxHp} HP</div>
        `;
        
        if (poke.hp <= 0) {
            btn.disabled = true;
            btn.innerHTML += "<span>FAINTED</span>";
        }
        if (index === gameState.currentTeamIndex) {
            btn.disabled = true;
            btn.innerHTML += "<span>ACTIVE</span>";
        }
        
        switchGrid.appendChild(btn);
    });
    
    updateMenuSelection();
}
   
    // Hide switch menu
    function cancelSwitch() {
        gameState.battleMenuState = 'main';
        gameState.menuSelectionIndex = 0;
        moveGridEl.style.display = 'grid';
        itemSectionEl.style.display = 'grid';
        switchScreen.classList.remove('active');
        updateBattle();
    }
    // Perform the actual switch
    function executeSwitch(newIndex) {
        // Kontrol: Bayılan Pokémon'dan geçiş mi yapılıyor? (Diyalog sırasının hemen ardından sırayı tekrar oyuncuya vermek için)
        const wasForcedSwitch = !gameState.isPlayerTurn && gameState.battleMenuState === 'switch'; 

        if (newIndex === gameState.currentTeamIndex) return;
       
        const oldPoke = gameState.playerTeam[gameState.currentTeamIndex].name;
        gameState.currentTeamIndex = newIndex;
       
        showBattleMessageSequence([
            {speaker: 'Player', text: `That's enough, ${oldPoke}! Come back!`}
        ], () => {
           
            battleMessageEl.textContent = `Go, ${gameState.playerTeam[newIndex].name}!`;
           
            gameState.isPlayerTurn = false;
            disableButtons();
           
            // DÜZELTME: Ana menüye dönüşü burada zorluyoruz (switch'in takılı kalmasını önler)
            gameState.battleMenuState = 'main';
            updateBattle();
           
            // Eğer zorunlu geçişse (yani oyuncunun sırası değildi)
            if (wasForcedSwitch) {
                // Sırayı tekrar oyuncuya ver
                setTimeout(() => {
                    gameState.isPlayerTurn = true;
                    gameState.battleMenuState = 'main';
                    updateBattle();
                    showBattleMessageSequence([{speaker: 'Player', text: `What will you do?`}]); // Yeni aksiyon mesajı
                }, 1000);
            } else {
                // Normal switch ise (oyuncunun sırasıydı) sıra düşmana geçer
                setTimeout(enemyAttack, 1500);
            }
        });
       
    }
   
    function endGame(won) {
    for (let key in audio) {
        audio[key].pause();
        audio[key].currentTime = 0;
    }
    document.getElementById('bootScreen').classList.remove('active');
    document.getElementById('worldContainer').classList.remove('active');
    document.getElementById('battleContainer').classList.remove('active');
    document.getElementById('victoryScreen').classList.remove('active');
    document.getElementById('transitionScreen').classList.remove('active');
    const gameOverEl = document.getElementById('gameOverImg');
    gameOverEl.classList.add('active'); // Bu tüm game container'ı kaplayacak
    if (won) {
        gameOverEl.innerHTML = `<img src="${kazandinURL}" alt="Champion!" style="width:100%; height:100%; object-fit:cover;">`;
    } else {
        // KAYBETTİNİZ KISMI
        try {
            audio.gameOver.play().catch(e => console.log("Game Over music failed to play:", e));
        } catch(e) {}
        gameOverEl.innerHTML = `<img src="${kaybettinURL}" alt="Game Over" style="width:100%; height:100%; object-fit:cover;">`;
    }
}
    // Movement check (Aynı Kaldı)
    function canMoveTo(x, y) {
        return labyrinthPath.some(pos => pos.x === x && pos.y === y);
    }
   
    // Check collision and start battle if necessary (Aynı Kaldı)
    function checkTrainerCollision(newX, newY) {
        const i = gameState.trainersDefeated;
        if (i >= trainersData.length) return false; 

        const pos = trainerPositions[i];
        const collisionDistance = 2; 

        const dx = Math.abs(newX - pos.x);
        const dy = Math.abs(newY - pos.y);
        
        if (dx <= collisionDistance && dy <= collisionDistance) {
            setTimeout(() => { 
                startMapDialogue(trainersData[i].preBattleDialogue, () => {
                    startBattle(i);
                });
            }, 100);
            return true;
        }
        return false;
    }
   
    // SCROLLING MAP (CAMERA SYSTEM) (Aynı Kaldı)
    function drawWorld() {
        if (!ctx) return;
       
        gameState.cameraX = (gameState.playerX * MAP_GRID_SIZE + MAP_GRID_SIZE / 2) - canvas.width / 2;
        gameState.cameraY = (gameState.playerY * MAP_GRID_SIZE + MAP_GRID_SIZE / 2) - canvas.height / 2;
        ctx.fillStyle = '#2a2a2a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
       
        if (mapBgImage && mapBgImage.complete && mapBgImage.naturalWidth > 0) {
            ctx.drawImage(mapBgImage, -gameState.cameraX, -gameState.cameraY, mapBgImage.width, mapBgImage.height);
        }
        ctx.fillStyle = 'rgba(0, 0, 0, 0.0)';
        for (let pos of labyrinthPath) {
            ctx.fillRect(
                pos.x * MAP_GRID_SIZE - gameState.cameraX,
                pos.y * MAP_GRID_SIZE - gameState.cameraY,
                MAP_GRID_SIZE,
                MAP_GRID_SIZE
            );
        }
       
        trainerPositions.forEach((pos, i) => {
            if (i < gameState.trainersDefeated) return;
            const img = trainerImages[i];
            const trainerWidth = MAP_GRID_SIZE;
            const trainerHeight = MAP_GRID_SIZE * 2;
            const drawX = pos.x * MAP_GRID_SIZE - gameState.cameraX;
            const drawY = pos.y * MAP_GRID_SIZE - gameState.cameraY;
            if (drawX > -trainerWidth && drawX < canvas.width && drawY > -trainerHeight && drawY < canvas.height) {
                if (img && img.complete && img.naturalWidth > 0) {
                    ctx.drawImage(img, drawX, drawY, trainerWidth, trainerHeight);
                } else {
                    ctx.fillStyle = '#ff6b6b';
                    ctx.fillRect(drawX, drawY, trainerWidth, trainerHeight);
                }
            }
        });
       
        const playerHeight = MAP_GRID_SIZE * 2;
        const playerWidth = MAP_GRID_SIZE;
       
        const playerDrawX = (canvas.width / 2) - (playerWidth / 2);
        const playerDrawY = (canvas.height / 2) + (MAP_GRID_SIZE / 2) - playerHeight;
        const currentImage = playerImages[gameState.playerDirection];
        if (currentImage && currentImage.complete && currentImage.naturalWidth > 0) {
            ctx.drawImage(currentImage, playerDrawX, playerDrawY, playerWidth, playerHeight);
        } else {
            ctx.fillStyle = '#6b9eff';
            ctx.fillRect(playerDrawX, playerDrawY, playerWidth, playerHeight);
        }
    }
    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (gameState.scene === 'world') {
            let newX = gameState.playerX;
            let newY = gameState.playerY;
            let newDirection = gameState.playerDirection;
           
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') { newY--; newDirection = 'back'; }
            else if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') { newY++; newDirection = 'front'; }
            else if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') { newX--; newDirection = 'left'; }
            else if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') { newX++; newDirection = 'right'; }
            else return;
           
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                playSelectSound();
            }
            gameState.playerDirection = newDirection;
            if (canMoveTo(newX, newY)) {
                const isCollision = checkTrainerCollision(newX, newY);
                if (!isCollision) {
                    gameState.playerX = newX;
                    gameState.playerY = newY;
                }
                drawWorld();
            } else {
                drawWorld();
            }
        }
        else if (gameState.scene === 'worldDialogue' && (e.key === 'Enter' || e.key === ' ')) {
            showNextDialogueLine();
        }
        else if (gameState.scene === 'battleDialogue' && (e.key === 'Enter' || e.key === ' ')) {
            showNextBattleLine();
        }
        else if (gameState.scene === 'battle' && gameState.isPlayerTurn) {
            handleBattleMenuInput(e);
        }
    });
    // ===== INIT BLOKU (En sonda) =====
    // Small delay for preloading images
    window.onload = function() {
        // Add images to DOM (to prevent errors)
        document.getElementById('bootImg').src = acilisResmiURL;
        document.getElementById('transitionImg').src = savasGirisURL;
        // Start the game
        showBootScreen();
    }
</script>
</body>
</html>
